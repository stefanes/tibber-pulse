trigger: none

schedules:
  # - cron: "0 23 * * *"
  #   displayName: At 23:00 # UTC = 00:00 CET/01:00 CEST
  - cron: "0 * * * *"
    displayName: At minute 0
    branches:
      include:
        - main
    always: true

pool:
  vmImage: windows-latest

variables:
  - group: tibber-pulse

resources:
  repositories:
    # See https://github.com/stefanes/azure-pipelines
    - repository: templates
      type: github
      endpoint: stefanes
      name: stefanes/azure-pipelines

jobs:
  - job:
    displayName: Tibber today's price info
    timeoutInMinutes: 30
    steps:
      - template: install-modules.yml@templates
        parameters:
          modules:
            - PSTibber
            - PSGraphite
          allowPrerelease: false
          reinstall: true

      - task: PowerShell@2
        inputs:
          filePath: $(Build.SourcesDirectory)/tibber-price.ps1
          arguments: -Today -Publish -TimeZone 'W. Europe Standard Time' -Verbose
          pwsh: true
        displayName: Get today's price info metrics
        retryCountOnTaskFailure: 10 # The maximum allowed number of attempts is 10
        env:
          TIBBER_ACCESS_TOKEN: $(TIBBER_API_KEY)
          GRAPHITE_ACCESS_TOKEN: $(GF_API_KEY)
